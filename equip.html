<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="./images/favicon.png" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <!-- CSS only -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />

    <script type="text/javascript">
      const server = "http://www.yd3team.store/api";

      document.addEventListener("DOMContentLoaded", function (event) {
        // DOM이 완성된 후 코드를 실행
        getEquipList();
        getEquipmentsList();
        // 이벤트 처리
        document
          .querySelector("#btnInsert")
          .addEventListener("click", insertEquipInfo);
      });

      // 설비 전체 조회
      async function getEquipList() {
        let equipList = await fetch(`${server}/equipment`)
          .then((res) => res.json())
          .catch((err) => console.log(err));

        // 태그삭제
        let trTags = document.querySelector(
          ".overflow-auto table.table > tbody"
        ).children;
        Array.from(trTags).forEach((trTag) => trTag.remove());

        for (let equipInfo of equipList) {
          createTrTag(
            equipInfo.equip_code,
            equipInfo.equip_name,
            equipInfo.equip_type_name
          );
        }
      }

      // 전체 조회 태그 만드는 코드
      function createTrTag(equip_code, equip_name, equip_type_name) {
        let trTag = `<tr>
                  <td class="text-center">${equip_code}</td>
                  <td class="text-center">${equip_name}</td>
                  <td class="text-center">${equip_type_name}</td>
                  <td class="text-center">
                    <button class="btnUpd">조회</button>
                    <button class="btnDel">삭제</button>
                  </td>
                </tr>`;
        let tbody = document.querySelector(
          ".overflow-auto table.table > tbody"
        );
        tbody.insertAdjacentHTML("beforeend", trTag);

        Array.from(tbody.querySelectorAll("tr button.btnUpd"))
          .pop()
          .addEventListener("click", getEquipInfo);
      }

      // 설비등록
      async function insertEquipInfo() {
        let equipInfo = getFormInfo();
        let result = await fetch(`${server}/equipment`, {
          method: "post",
          headers: {
            "Content-type": "application/json",
          },
          body: JSON.stringify(equipInfo),
        })
          .then((res) => res.json)
          .catch((err) => console.log(err));
        // 3. 결과 처리
        if (result) {
          // 등록 성공
          getEmpList();
          form1.reset();
        } else {
          alert("등록실패");
        }
      }

      // 설비등록할때 form태그 가져오는거
      function getFormInfo() {
        const formTag = new FormData(form1);
        let obj = {};

        for (let key of formTag.keys()) {
          let name = key;
          let value = formTag.get(key); // 그 key에 해당하는 value를 get해서 가져오는거임
          // list형식도 get해서 가져오는것처럼 key에해당하는 get해서 가져오는
          console.log(name, value);
          obj[name] = value;
        }
        console.log(obj);
        return obj;
      }

      // 설비유형을 가져오는 코드
      async function getEquipmentsList() {
        let equipmentsList = await fetch(`${server}/equipments`)
          .then((res) => res.json())
          .catch((err) => console.log(err));

        for (let equipmentsInfo of equipmentsList) {
          createOptionTag(equipmentsInfo.code, equipmentsInfo.name);
        }
      }

      // 설비유형 태그를 만드는 코드
      function createOptionTag(code, name) {
        let optiontag = `<option value="${code}">${name}</option>`;
        let options = document.querySelector(".form-horizontal select");
        options.insertAdjacentHTML("beforeend", optiontag);
        // 1. <option value="">선택</option> 생성
        // let optionTag = document.createElement("option");
        // optionTag.value = code;
        // optionTag.textContent = name;
        // 2. <select/> 탐색
        // document
        //   .querySelector('#form1 [name="equip_type_name"]')
        //   .insertAdjacentElement("beforeend", optionTag);
      }

      // 사원단건조회
      async function getEquipInfo(event) {
        let selectBtn = event.currentTarget;
        let trTag = selectBtn.closest("tr");
        let firstTdTag = trTag.firstElementChild;
        let equip_code = firstTdTag.textContent;

        let equipInfo = await fetch(`${server}/equipment/${equip_code}`)
          .then((res) => res.json())
          .catch((err) => console.log(err));

        form1.querySelector('[name="equip_code"]').value = equipInfo.equip_code;
        form1.querySelector('[name="equip_name"]').value = equipInfo.equip_name;
        form1.querySelector('[name="equip_type"]').value = equipInfo.equip_type;

        form1.querySelector('[name="equip_status_name"]').value =
          equipInfo.equip_status_name;

        function dateForm(e) {
          let d = new Date(e);
          let year = d.getFullYear();
          let mon = ("0" + (d.getMonth() + 1)).slice(-2);
          let date = ("0" + d.getDate()).slice(-2);
          let idForm = year + "-" + mon + "-" + date;
          return idForm;
        }
        form1.querySelector('[name="install_date"]').value = dateForm(
          equipInfo.install_date
        );
        form1.querySelector('[name="mfg_dt"]').value = dateForm(
          equipInfo.mfg_dt
        );
      }
    </script>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col">
          <h2>사원 목록</h2>
          <div class="overflow-auto border" style="height: 700px">
            <table class="table text-center">
              <thead>
                <tr>
                  <th class="text-center">설비코드</th>
                  <th class="text-center">설비명</th>
                  <th class="text-center">설비유형</th>
                  <th class="text-center"></th>
                </tr>
              </thead>

              <tbody>
                <tr>
                  <td class="text-center">100</td>
                  <td class="text-center">홍길동</td>
                  <td class="text-center">PROGRAMER</td>
                  <td class="text-center">
                    <button class="btnUpd">조회</button>
                    <button class="btnDel">삭제</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="col">
          <form id="form1" class="form-horizontal">
            <h2>사원 등록 및 수정</h2>
            <div class="border">
              <div class="form-group m-3">
                <label>설비코드:</label>
                <input
                  type="text"
                  class="form-control"
                  readonly
                  name="equip_code"
                />
              </div>
              <div class="form-group m-3">
                <label>설비이름:</label>
                <input type="text" class="form-control" name="equip_name" />
              </div>
              <div class="form-group m-3">
                <label>설비유형:</label>
                <select class="form-control" name="equip_type" id="equip_type">
                  <option value=""></option>
                </select>
              </div>
              <div class="form-group m-3">
                <label>설치일자:</label>
                <input type="date" class="form-control" name="install_date" />
              </div>
              <div class="form-group m-3">
                <label>제조일자:</label>
                <input type="date" class="form-control" name="mfg_dt" />
              </div>
              <div class="form-group m-3">
                <label>설비상태:</label>
                <input
                  type="text"
                  class="form-control"
                  name="equip_status_name"
                />
              </div>
              <div class="form-group m-2">
                <input
                  type="button"
                  class="btn btn-primary"
                  value="등록"
                  id="btnInsert"
                />
                <input
                  type="button"
                  class="btn btn-primary"
                  value="수정"
                  id="btnUpdate"
                />
                <input
                  type="button"
                  class="btn btn-primary"
                  value="초기화"
                  id="btnInit"
                />
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </body>
</html>
